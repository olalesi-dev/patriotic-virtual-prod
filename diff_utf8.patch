diff --git a/public/index.html b/public/index.html
index a513d9c..59b5244 100644
--- a/public/index.html
+++ b/public/index.html
@@ -2543,29 +2543,26 @@
 
     /* Premium Specific Header for Patient Chart */
     .modal.wide .modal-header {
-      background: var(--g50);
-      /* Match sidebar background for seamless look, or white? Sidebar is g50 on my recent edit... actually sidebar is inside body. Header is top. */
-      /* Let's keep white or match body. Default modal header is likely white. */
+      background: #0A0F1C !important;
       padding: 20px 30px;
       display: flex;
       justify-content: space-between;
       align-items: center;
       flex-direction: row-reverse;
-      /* Move Title to Right, Close to Left */
+      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
     }
 
     .modal.wide .modal-header h3 {
       font-family: 'Fraunces', serif;
       font-size: 32px;
       font-style: italic;
-      color: var(--navy);
+      color: #FFFFFF !important;
       margin: 0;
       letter-spacing: -0.5px;
     }
 
     .modal.wide .modal-close {
       position: static;
-      /* Override absolute positioning if any */
       font-size: 24px;
       width: 40px;
       height: 40px;
@@ -2573,10 +2570,10 @@
       align-items: center;
       justify-content: center;
       border-radius: 50%;
-      background: white;
-      border: 1px solid var(--g200);
+      background: #1F2937;
+      border: 1px solid rgba(255, 255, 255, 0.1);
       cursor: pointer;
-      color: var(--g500);
+      color: #FFFFFF;
       transition: all 0.2s;
     }
 
@@ -2601,17 +2598,16 @@
     /* Ensure Footer is at Bottom */
     .modal.wide .modal-footer {
       padding: 20px 30px;
-      background: white;
-      border-top: 1px solid var(--g200);
+      background: #0A0F1C;
+      border-top: 1px solid rgba(255, 255, 255, 0.1);
       margin-top: auto;
-      /* Push to bottom if content is short */
       flex-shrink: 0;
     }
 
     .chart-tabs {
       display: flex;
-      border-bottom: 1px solid var(--g200);
-      background: white;
+      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
+      background: #0A0F1C;
       padding: 0 20px;
     }
 
@@ -2619,7 +2615,7 @@
     .chart-tabs .chart-tab {
       padding: 15px 20px;
       font-weight: 500;
-      color: var(--g500);
+      color: rgba(255, 255, 255, 0.6);
       cursor: pointer;
       border-bottom: 2px solid transparent;
     }
@@ -2634,7 +2630,7 @@
       flex: 1;
       overflow-y: auto;
       padding: 20px;
-      background: var(--g50);
+      background: #000000;
       display: none;
     }
 
@@ -2671,6 +2667,82 @@
       border-bottom-color: var(--blue);
     }
 
+    /* PATIENT DASHBOARD TABS */
+    .dash-tabs {
+      display: flex;
+      gap: 20px;
+      border-bottom: 1px solid var(--g200);
+      background: var(--navy-mid);
+      padding: 0 20px;
+    }
+
+    .dash-tab {
+      padding: 14px 10px;
+      font-size: 14px;
+      font-weight: 600;
+      color: var(--g500);
+      cursor: pointer;
+      border-bottom: 2.5px solid transparent;
+      transition: all 0.2s var(--ease);
+      user-select: none;
+    }
+
+    .dash-tab:hover {
+      color: white;
+    }
+
+    .dash-tab.active {
+      color: white;
+      border-bottom-color: var(--blue);
+    }
+
+    .billing-card {
+      background: white;
+      border-radius: 12px;
+      border: 1px solid var(--g100);
+      padding: 20px;
+      margin-bottom: 20px;
+    }
+
+    .status-pill {
+      display: inline-flex;
+      align-items: center;
+      gap: 6px;
+      padding: 4px 12px;
+      border-radius: 100px;
+      font-size: 11px;
+      font-weight: 700;
+      text-transform: uppercase;
+      letter-spacing: 0.5px;
+    }
+
+    .status-pill.active {
+      background: var(--emerald-soft);
+      color: var(--emerald);
+    }
+
+    .status-pill.issue {
+      background: var(--red-soft);
+      color: var(--red);
+    }
+
+    .status-pill.cancelled {
+      background: var(--g100);
+      color: var(--g500);
+    }
+
+    /* CALENDAR EVENT HOVER */
+    .fc-event {
+      cursor: pointer;
+      transition: transform 0.2s var(--ease), box-shadow 0.2s var(--ease) !important;
+    }
+
+    .fc-event:hover {
+      transform: translateY(-1px);
+      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
+      filter: brightness(1.1);
+    }
+
     .msg-thread {
       transition: background 0.2s;
     }
@@ -3700,7 +3772,6 @@
           Clinicians and Facilities</a><a href="#testimonials">Reviews</a>
       </div>
       <div class="nav-actions">
-        <a href="/emr/" class="btn btn-ghost" style="text-decoration:none">EMR Portal</a>
         <button class="btn btn-ghost" id="loginBtn" onclick="openModal('login')">Log In</button>
         <button class="btn btn-primary" id="signupBtn" onclick="openModal('register')">Get Started</button>
         <button class="btn btn-ghost hidden" id="dashBtn" onclick="showDashboard()">Dashboard</button>
@@ -4154,17 +4225,132 @@
           <div class="dsc-v">0</div>
         </div>
       </div>
-      <div class="dg">
-        <div class="dc">
-          <div class="dc-h">
-            <h3>Recent Visits</h3><button class="btn btn-ghost" style="font-size:13px">View All</button>
+      <div class="dash-tabs" style="margin: 0 -20px 24px -20px; position: sticky; top: 0; z-index: 10">
+        <div class="dash-tab active" id="tabHead-visits" onclick="switchDashTab('visits')">Care History</div>
+        <div class="dash-tab" id="tabHead-schedule" onclick="switchDashTab('schedule')">Schedule</div>
+        <div class="dash-tab" id="tabHead-users" onclick="switchDashTab('users')">User Management</div>
+        <div class="dash-tab" id="tabHead-billing" onclick="switchDashTab('billing')">Billing & Plans</div>
+      </div>
+
+      <div class="dg" style="align-items: flex-start">
+        <div style="flex: 1; min-width: 0">
+          <!-- TAB: VISITS -->
+          <div id="tab-dash-visits" class="dc shadow-sm">
+            <div class="dc-h">
+              <h3>Recent Visits</h3>
+              <button class="btn btn-ghost" style="font-size:13px" onclick="fetchConsultations()">Refresh</button>
+            </div>
+            <div id="cList">
+              <div style="padding:40px;text-align:center;color:var(--g400);font-size:14px">No visits yet. Start your
+                first consultation.</div>
+            </div>
           </div>
-          <div id="cList">
-            <div style="padding:40px;text-align:center;color:var(--g400);font-size:14px">No visits yet. Start your first
-              consultation.</div>
+
+          <!-- TAB: SCHEDULE -->
+          <div id="tab-dash-schedule" class="dc hidden shadow-sm">
+            <div class="dc-h">
+              <h3>My Appointments</h3>
+              <button class="btn btn-primary" style="font-size:12px;padding:6px 12px" onclick="openConsultation()">+
+                Schedule New</button>
+            </div>
+            <div style="padding:20px; height: 600px">
+              <div id="patientCalendar"></div>
+            </div>
+          </div>
+
+          <!-- TAB: USERS (Cloned from EMR) -->
+          <div id="tab-dash-users" class="hidden">
+            <div class="dc shadow-sm">
+              <div class="dc-h" style="display:flex; justify-content:space-between; align-items:center;">
+                <h3>User Accounts & Roles</h3>
+                <button class="btn btn-primary" style="font-size:12px;padding:6px 12px"
+                  onclick="document.getElementById('dashAddUserForm').classList.toggle('hidden')">+ Add New
+                  User</button>
+              </div>
+
+              <div id="dashAddUserForm" class="hidden"
+                style="padding:20px;background:#f8fafc;border-bottom:1px solid var(--g200);gap:15px;flex-wrap:wrap">
+                <div style="display:flex;gap:10px;width:100%;flex-wrap:wrap">
+                  <input type="text" id="dashNewUserFirstName" placeholder="First Name"
+                    style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:120px">
+                  <input type="text" id="dashNewUserLastName" placeholder="Last Name"
+                    style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:120px">
+                </div>
+                <div style="display:flex;gap:10px;width:100%;flex-wrap:wrap;margin-top:10px">
+                  <input type="email" id="dashNewUserEmail" placeholder="Email Address"
+                    style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:200px">
+                  <input type="password" id="dashNewUserPassword" placeholder="Initial Password"
+                    style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:150px">
+                </div>
+                <div style="display:flex;gap:10px;width:100%;align-items:center;margin-top:10px">
+                  <select id="dashNewUserRole"
+                    style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1">
+                    <option value="patient">Patient</option>
+                    <option value="provider">Provider</option>
+                    <option value="admin">Platform Admin</option>
+                  </select>
+                  <button class="btn btn-primary" onclick="createDashUser()" style="padding:8px 24px">Create
+                    Account</button>
+                </div>
+              </div>
+
+              <div style="overflow-x:auto;">
+                <table style="width:100%;border-collapse:collapse">
+                  <thead>
+                    <tr style="background:var(--g50);text-align:left;font-size:12px;color:var(--g500);">
+                      <th style="padding:15px">Name / Email</th>
+                      <th style="padding:15px">Role</th>
+                      <th style="padding:15px">Status</th>
+                      <th style="padding:15px">Actions</th>
+                    </tr>
+                  </thead>
+                  <tbody id="dashUserTableBody">
+                    <tr>
+                      <td colspan="4" style="padding:20px;text-align:center;color:var(--g400)">Load users...</td>
+                    </tr>
+                  </tbody>
+                </table>
+              </div>
+            </div>
+          </div>
+
+          <!-- TAB: BILLING -->
+          <div id="tab-dash-billing" class="hidden">
+            <div class="billing-card shadow-sm">
+              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
+                <div>
+                  <div
+                    style="font-size:11px;color:var(--g500);font-weight:700;text-transform:uppercase;margin-bottom:4px;letter-spacing:0.5px">
+                    Membership Plan</div>
+                  <h3 id="planTitle" style="margin:0;font-size:24px;color:var(--navy);font-weight:800">No Active Plan
+                  </h3>
+                  <p id="planPrice" style="color:var(--g600);margin-top:6px;font-size:15px">Subscribe to unlock premium
+                    features & discounted visits.</p>
+                </div>
+                <div id="subStatus" class="status-pill cancelled">Inactive</div>
+              </div>
+              <div style="display:flex;gap:12px;flex-wrap:wrap;border-top:1px solid var(--g100);padding-top:20px">
+                <button class="btn btn-primary" id="upgradeBtn" onclick="upgradePlan()">Upgrade / Subscribe</button>
+                <button class="btn btn-outline" onclick="manageBilling()">Manage Payment</button>
+                <button id="reactivateBtn" class="btn btn-outline hidden" onclick="reactivateSubscription()"
+                  style="border-color:var(--emerald);color:var(--emerald);font-weight:700">Reactivate
+                  Subscription</button>
+              </div>
+            </div>
+
+            <div class="dc shadow-sm">
+              <div class="dc-h">
+                <h3 style="font-size:16px">Payment History</h3>
+              </div>
+              <div id="paymentList" style="padding:0">
+                <div style="padding:40px;text-align:center;color:var(--g400);font-size:14px;background:var(--g50)">No
+                  transaction history available.</div>
+              </div>
+            </div>
           </div>
         </div>
-        <div class="dc">
+
+        <div class="dc shadow-sm" style="width: 320px; flex-shrink: 0">
           <div class="dc-h">
             <h3>Quick Actions</h3>
           </div>
@@ -4183,18 +4369,18 @@
                 <p>View active meds</p>
               </div>
             </div>
-            <div class="cli">
-              <div class="cli-ic" style="background:var(--amber-soft)">≡ƒö¼</div>
+            <div class="cli" onclick="openResults()">
+              <div class="cli-ic" style="background:var(--indigo-pale); background:#E8EDFF">≡ƒôè</div>
               <div class="cli-info">
-                <h4>Radiology</h4>
-                <p>Second opinions & AI</p>
+                <h4>My Results</h4>
+                <p>View tests & reports</p>
               </div>
             </div>
-            <div class="cli" onclick="openVideoConsult()">
-              <div class="cli-ic" style="background:var(--rose-soft)">≡ƒô╣</div>
+            <div class="cli">
+              <div class="cli-ic" style="background:var(--amber-soft)">≡ƒº¬</div>
               <div class="cli-info">
-                <h4>Video Consult</h4>
-                <p>Start video visit</p>
+                <h4>Labs</h4>
+                <p>Blood work & testing</p>
               </div>
             </div>
           </div>
@@ -4203,6 +4389,25 @@
     </div>
   </div>
 
+  <!-- RESULTS MODAL -->
+  <div class="mo" id="resultsModal" onclick="this.classList.remove('active')">
+    <div class="modal cm" onclick="event.stopPropagation()" style="max-width:800px">
+      <div
+        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid var(--g100);padding-bottom:15px">
+        <h2 style="margin:0">My Results & Reports</h2>
+        <button class="btn btn-ghost"
+          onclick="document.getElementById('resultsModal').classList.remove('active')">Γ£ò</button>
+      </div>
+      <div id="resultsContent" style="min-height:300px">
+        <div style="padding:40px;text-align:center;color:var(--g400)">Loading your results...</div>
+      </div>
+      <div style="margin-top:20px;text-align:right">
+        <button class="btn btn-ghost"
+          onclick="document.getElementById('resultsModal').classList.remove('active')">Close</button>
+      </div>
+    </div>
+  </div>
+
   <!-- AUTH MODAL -->
   <div class="mo" id="authModal" onclick="closeModal(event)">
     <div class="modal" onclick="event.stopPropagation()">
@@ -4362,31 +4567,64 @@
 
   <!-- BOOKING WIZARD MODAL (Phase 7) -->
   <div class="mo" id="bookingModal">
-    <div class="modal cm" style="max-width:600px; display:flex; flex-direction:column; max-height:85vh">
-      <div class="modal-header">
-        <h3>Schedule Appointment</h3>
-        <button class="modal-close"
+    <div class="modal cm"
+      style="max-width:700px; display:flex; flex-direction:column; max-height:90vh; background: var(--navy-mid); border: 1px solid var(--g200)">
+      <div class="modal-header" style="border-bottom: 1px solid var(--g200); padding: 20px">
+        <h3 style="color: white; margin: 0">Schedule Your Appointment</h3>
+        <button class="modal-close" style="color: white"
           onclick="document.getElementById('bookingModal').classList.remove('active')">├ù</button>
       </div>
-      <div class="modal-body" style="overflow-y:auto; padding:20px">
+      <div class="modal-body" style="overflow-y:auto; padding:24px">
         <input type="hidden" id="bookingConsultId">
 
-        <h4 style="margin-top:0;color:var(--navy)">1. Select Date</h4>
-        <div id="bookingDateGrid" class="date-grid">
-          <!-- Populated by JS -->
+        <!-- STEP 1: SELECT DOCTOR -->
+        <div id="step-doctor">
+          <h4
+            style="margin-top:0;color:var(--g500);text-transform:uppercase;font-size:12px;letter-spacing:1px;margin-bottom:16px">
+            1. Select Your Provider</h4>
+          <div id="doctorGrid"
+            style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; margin-bottom:32px">
+            <!-- Populated by JS -->
+            <div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--g500)">Loading doctors...</div>
+          </div>
         </div>
 
-        <h4 style="color:var(--navy);margin-top:20px">2. Select Time (EST)</h4>
-        <div id="bookingTimeGrid" class="time-grid">
-          <div
-            style="grid-column:1/-1;text-align:center;color:var(--g500);padding:20px;background:var(--g50);border-radius:8px">
-            Select a date first</div>
+        <!-- STEP 2 & 3: DATE & TIME (Visible after doctor selection) -->
+        <div id="bookingDetails" class="hidden">
+          <div id="selectedDoctorInfo"
+            style="display:flex; align-items:center; gap:16px; background:rgba(255,255,255,0.03); padding:16px; border-radius:12px; border:1px solid var(--g200); margin-bottom:24px">
+            <!-- Info of selected doctor -->
+          </div>
+
+          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:32px">
+            <div>
+              <h4
+                style="color:var(--g500);text-transform:uppercase;font-size:12px;letter-spacing:1px;margin-bottom:12px">
+                2. Select Date</h4>
+              <div id="bookingDateGrid" class="date-grid"
+                style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px">
+                <!-- Populated by JS -->
+              </div>
+            </div>
+            <div>
+              <h4
+                style="color:var(--g500);text-transform:uppercase;font-size:12px;letter-spacing:1px;margin-bottom:12px">
+                3. Select Time (EST)</h4>
+              <div id="bookingTimeGrid" class="time-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
+                <div
+                  style="grid-column:1/-1;text-align:center;color:var(--g500);padding:20px;background:rgba(255,255,255,0.02);border-radius:8px;font-size:13px">
+                  Select a date first</div>
+              </div>
+            </div>
+          </div>
         </div>
       </div>
       <div class="modal-footer"
-        style="padding:15px;border-top:1px solid var(--g200);display:flex;justify-content:flex-end">
-        <button class="btn btn-primary" id="btnConfirmBook" disabled onclick="confirmBooking()">Confirm
-          Appointment</button>
+        style="padding:20px;border-top:1px solid var(--g200);display:flex;justify-content:space-between;align-items:center">
+        <button id="btnBackToDoctors" class="btn btn-ghost hidden" onclick="backToDoctorSelection()"
+          style="color:var(--g500)">ΓåÉ Change Provider</button>
+        <button class="btn btn-primary" id="btnConfirmBook" disabled onclick="confirmBooking()"
+          style="margin-left:auto; min-width:200px">Confirm Appointment</button>
       </div>
     </div>
   </div>
@@ -4506,6 +4744,9 @@
       <h2>Appointment Details</h2>
       <div id="apptDetailsContent" style="margin-top:20px; text-align:left"></div>
       <div style="margin-top:24px;display:flex;gap:10px;justify-content:flex-end">
+        <button class="btn btn-primary" style="background:var(--blue); border-color:var(--blue)"
+          onclick="openVideoConsult(); document.getElementById('apptModal').classList.remove('active');">Video
+          Consult</button>
         <button class="btn btn-primary"
           onclick="if(window.currentAptConsultId) viewIntake(window.currentAptConsultId); document.getElementById('apptModal').classList.remove('active');">View
           Intake</button>
@@ -4536,6 +4777,7 @@
               style="background:var(--red);color:white;font-size:10px;padding:2px 6px;border-radius:10px;display:none">0</span>
           </div>
           <div id="tab-admin-schedule" class="admin-tab" onclick="switchAdminTab('schedule')">Schedule</div>
+          <div id="tab-admin-users" class="admin-tab" onclick="switchAdminTab('users')">User Management</div>
         </div>
 
         <div id="view-admin-consults" style="flex:1;overflow-y:auto">
@@ -4585,6 +4827,56 @@
           </div>
         </div>
 
+        <div id="view-admin-users" style="display:none;flex:1;overflow-y:auto">
+          <div
+            style="padding:15px 20px;border-bottom:1px solid var(--g200);display:flex;justify-content:space-between;align-items:center;background:white">
+            <h3 style="margin:0;font-size:16px;color:var(--navy)">User Management</h3>
+            <button class="btn btn-primary" onclick="toggleAddUserForm()" style="font-size:13px;padding:8px 16px">Add
+              New
+              User</button>
+          </div>
+
+          <div id="addUserForm"
+            style="display:none;padding:20px;background:#f8fafc;border-bottom:1px solid var(--g200);gap:15px;flex-wrap:wrap">
+            <div style="display:flex;gap:10px;width:100%;flex-wrap:wrap">
+              <input type="text" id="newUserFirstName" placeholder="First Name"
+                style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:120px">
+              <input type="text" id="newUserLastName" placeholder="Last Name"
+                style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:120px">
+            </div>
+            <div style="display:flex;gap:10px;width:100%;flex-wrap:wrap;margin-top:10px">
+              <input type="email" id="newUserEmail" placeholder="Email Address"
+                style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:200px">
+              <input type="password" id="newUserPassword" placeholder="Initial Password"
+                style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1;min-width:150px">
+            </div>
+            <div style="display:flex;gap:10px;width:100%;align-items:center;margin-top:10px">
+              <select id="newUserRole"
+                style="padding:8px;border-radius:6px;border:1px solid var(--g200);font-size:13px;flex:1">
+                <option value="patient">Patient</option>
+                <option value="provider">Provider</option>
+                <option value="doctor">Doctor</option>
+                <option value="admin">Platform Admin</option>
+              </select>
+              <button onclick="createNewUser()" class="btn btn-primary"
+                style="padding:10px 20px;height:38px;font-size:13px">Create User</button>
+            </div>
+          </div>
+          <table style="width:100%;border-collapse:collapse">
+            <thead>
+              <tr style="background:var(--g50);text-align:left;font-size:13px;color:var(--g500);position:sticky;top:0">
+                <th style="padding:15px 20px">User</th>
+                <th style="padding:15px">Email</th>
+                <th style="padding:15px">Current Role</th>
+                <th style="padding:15px">Assign Role</th>
+              </tr>
+            </thead>
+            <tbody id="adminUserTableBody">
+              <!-- Populated by JS -->
+            </tbody>
+          </table>
+        </div>
+
         <!-- SCHEDULE VIEW -->
         <div id="view-admin-schedule" style="display:none;flex:1;overflow:hidden;position:relative">
           <div
@@ -4592,7 +4884,40 @@
             <h3 style="margin:0;font-size:16px;color:var(--navy)">My Schedule</h3>
             <div style="font-size:13px;color:var(--g500)" id="todaysAgenda"></div>
           </div>
-          <div id="providerCalendar" style="height:calc(100% - 60px);padding:20px;background:white"></div>
+          <div id="availability-tool"
+            style="padding:15px 20px;background:#0A0F1C;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;gap:15px;align-items:flex-end;flex-wrap:wrap">
+            <div style="display:flex;flex-direction:column;gap:5px">
+              <label style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase">Start
+                Date &
+                Time</label>
+              <div style="display:flex;gap:5px">
+                <input type="date" id="availStartDate"
+                  style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:#1F2937;color:white;font-size:13px">
+                <input type="time" id="availStartTime" value="09:00"
+                  style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:#1F2937;color:white;font-size:13px">
+              </div>
+            </div>
+            <div style="display:flex;flex-direction:column;gap:5px">
+              <label style="font-size:11px;font-weight:700;color:rgba(255,255,255,0.5);text-transform:uppercase">End
+                Date &
+                Time</label>
+              <div style="display:flex;gap:5px">
+                <input type="date" id="availEndDate"
+                  style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:#1F2937;color:white;font-size:13px">
+                <input type="time" id="availEndTime" value="17:00"
+                  style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:#1F2937;color:white;font-size:13px">
+              </div>
+            </div>
+            <button onclick="addAvailabilityRange()" class="btn btn-primary"
+              style="padding:10px 20px;height:38px;font-size:13px">Set Availability</button>
+          </div>
+          <div id="providerCalendar" style="height:calc(100% - 130px);padding:20px;background:white"></div>
+        </div>
+
+        <!-- PACS VIEW -->
+        <div id="view-admin-pacs" style="display:none;flex:1;overflow:hidden">
+          <iframe id="pacsFrame" src="" style="width:100%;height:100%;border:none"
+            allow="autoplay; fullscreen; microphone; camera; display-capture; encrypted-media"></iframe>
         </div>
       </div>
     </div>
@@ -5104,6 +5429,12 @@
       if (user) document.getElementById('dashWelcome').textContent = 'Welcome back, ' + user.firstName;
       await fetchConsultations();
 
+      // Initialize Calendar
+      setTimeout(() => { if (patientCalendar) patientCalendar.updateSize(); else initPatientCalendar(); }, 100);
+
+      // Reset tabs to default
+      switchDashTab('visits');
+
       // Check for Payment Success Return
       const params = new URLSearchParams(window.location.search);
       if (params.get('payment') === 'success') {
@@ -5118,6 +5449,230 @@
       }
     }
 
+    function switchDashTab(tab) {
+      document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
+      const activeTab = document.getElementById('tabHead-' + tab);
+      if (activeTab) activeTab.classList.add('active');
+
+      ['visits', 'schedule', 'billing', 'users'].forEach(id => {
+        const el = document.getElementById('tab-dash-' + id);
+        if (el) el.classList.add('hidden');
+      });
+      const contentEl = document.getElementById('tab-dash-' + tab);
+      if (contentEl) contentEl.classList.remove('hidden');
+
+      if (tab === 'schedule' && window.patientCalendar) {
+        setTimeout(() => patientCalendar.updateSize(), 50);
+      }
+      if (tab === 'billing') {
+        fetchBillingInfo();
+      }
+      if (tab === 'users') {
+        loadDashUsers();
+      }
+    }
+
+    async function fetchBillingInfo() {
+      if (!user || !token) return;
+      const statusEl = document.getElementById('subStatus');
+      const titleEl = document.getElementById('planTitle');
+      const priceEl = document.getElementById('planPrice');
+      const listEl = document.getElementById('paymentList');
+      const reactivateBtn = document.getElementById('reactivateBtn');
+      const upgradeBtn = document.getElementById('upgradeBtn');
+
+      try {
+        // Fetch current subscription status from user data or dedicated endpoint
+        // For now, checks user metadata
+        if (user.subscription) {
+          titleEl.textContent = user.subscription.planName || 'Active Membership';
+          priceEl.textContent = `$${user.subscription.amount / 100} / month`;
+          statusEl.textContent = user.subscription.status || 'Active';
+          statusEl.className = 'status-pill ' + (user.subscription.status === 'active' ? 'active' : (user.subscription.status === 'past_due' ? 'issue' : 'cancelled'));
+
+          if (user.subscription.status === 'canceled' || user.subscription.status === 'past_due') {
+            reactivateBtn.classList.remove('hidden');
+          } else {
+            reactivateBtn.classList.add('hidden');
+          }
+          upgradeBtn.textContent = 'Change Plan';
+        }
+
+        // Fetch Payments
+        const payRes = await fetch(`${API}/api/v1/billing/payments`, {
+          headers: { Authorization: `Bearer ${token}` }
+        });
+        if (payRes.ok) {
+          const payments = await payRes.json();
+          // Filter payments for this specific user
+          const myPayments = payments.filter(p => p.patientId === user.uid || p.userId === user.uid || p.uid === user.uid);
+
+          if (myPayments.length > 0) {
+            listEl.innerHTML = myPayments.map(p => `
+              <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--g100);background:white">
+                <div>
+                  <div style="font-weight:700;color:var(--navy);font-size:14px">${p.description || 'Medical Service'}</div>
+                  <div style="font-size:12px;color:var(--g500)">${new Date(p.date || p.createdAt).toLocaleDateString()}</div>
+                </div>
+                <div style="text-align:right">
+                  <div style="font-weight:800;color:var(--navy)">$${(p.amount / 100).toFixed(2)}</div>
+                  <div style="font-size:11px;color:var(--emerald);font-weight:800;letter-spacing:0.5px">PAID</div>
+                </div>
+              </div>
+            `).join('');
+          } else {
+            listEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--g400);font-size:14px;background:var(--g50)">No transaction history available.</div>';
+          }
+        }
+      } catch (e) {
+        console.error('Billing fetch error:', e);
+      }
+    }
+
+    function upgradePlan() {
+      toast('Redirecting to secure plan selection...');
+      openConsultation(); // Use visit modal for now which has service selection
+    }
+
+    async function manageBilling() {
+      toast('Opening secure billing portal...');
+      try {
+        const res = await fetch(`${API}/api/v1/payments/create-portal-session`, {
+          method: 'POST',
+          headers: { 'Authorization': `Bearer ${token}` }
+        });
+        const data = await res.json();
+        if (data.url) window.location.href = data.url;
+        else toast('Portal temporarily unavailable. Use Stripe dashboard.');
+      } catch (e) {
+        toast('Secure billing portal failed to load.');
+      }
+    }
+
+    function reactivateSubscription() {
+      toast('Reactivating your subscription...');
+      upgradePlan();
+    }
+
+    async function openResults() {
+      document.getElementById('resultsModal').classList.add('active');
+      const content = document.getElementById('resultsContent');
+      content.innerHTML = '<div style="padding:40px;text-align:center;color:var(--g400)">Fetching your clinical reports...</div>';
+
+      try {
+        const idToken = await auth.currentUser.getIdToken();
+        const res = await fetch(`${API}/api/v1/doctor/patients/${user.uid}`, {
+          headers: { Authorization: `Bearer ${idToken}` }
+        });
+        const data = await res.json();
+
+        if (!data.labs || data.labs.length === 0) {
+          content.innerHTML = '<div style="padding:40px;text-align:center;color:var(--g400)">No lab results available yet.</div>';
+          return;
+        }
+
+        content.innerHTML = `
+          <div style="display:grid;gap:15px">
+            ${data.labs.map(l => `
+              <div style="padding:15px;border:1px solid var(--g100);border-radius:12px;background:var(--g50);display:flex;justify-content:space-between;align-items:center">
+                <div>
+                  <div style="font-weight:700;color:var(--navy);font-size:15px">${l.panels.join(', ')}</div>
+                  <div style="font-size:12px;color:var(--g500)">Status: <span style="font-weight:700;color:${l.status === 'reviewed' ? '#00D9A3' : '#FFB800'}">${l.status.replace(/_/g, ' ')}</span> ΓÇó ${new Date(l.createdAt._seconds ? l.createdAt._seconds * 1000 : l.createdAt).toLocaleDateString()}</div>
+                </div>
+                <div style="display:flex;gap:8px">
+                  ${l.requisitionUrl ? `<a href="${l.requisitionUrl}" target="_blank" class="btn btn-ghost" style="font-size:11px;padding:5px 10px;text-decoration:none">Requisition</a>` : ''}
+                  ${l.resultUrl ? `<a href="${l.resultUrl}" target="_blank" class="btn btn-primary" style="font-size:11px;padding:5px 10px;text-decoration:none">View Result</a>` : ''}
+                </div>
+              </div>
+            `).join('')}
+          </div>
+        `;
+      } catch (err) {
+        console.error(err);
+        content.innerHTML = '<div style="padding:40px;text-align:center;color:var(--red)">Failed to load results. Please try again.</div>';
+      }
+    }
+
+    let patientCalendar;
+    function initPatientCalendar() {
+      const calendarEl = document.getElementById('patientCalendar');
+      if (!calendarEl) return;
+      if (patientCalendar) {
+        patientCalendar.render();
+        return;
+      }
+      patientCalendar = new FullCalendar.Calendar(calendarEl, {
+        initialView: 'dayGridMonth',
+        headerToolbar: {
+          left: 'prev,next today',
+          center: 'title',
+          right: 'dayGridMonth,timeGridWeek,timeGridDay'
+        },
+        height: '100%',
+        events: async function (info, successCallback, failureCallback) {
+          try {
+            const idToken = await auth.currentUser.getIdToken();
+            const res = await fetch(`${API}/api/v1/doctor/appointments`, {
+              headers: { Authorization: `Bearer ${idToken}` }
+            });
+            const data = await res.json();
+            // Filter only for current user
+            const myApts = data.filter(apt => apt.patientId === user.uid);
+            const events = myApts.map(apt => ({
+              id: apt.id,
+              title: apt.serviceName || 'Telehealth Visit',
+              start: apt.startTime,
+              end: new Date(new Date(apt.startTime).getTime() + (apt.durationMinutes * 60000)).toISOString(),
+              backgroundColor: 'var(--blue)',
+              borderColor: 'var(--blue)',
+              extendedProps: {
+                patientName: apt.patientName || 'Unknown',
+                patientEmail: apt.patientEmail || '',
+                serviceName: apt.serviceName || 'Consultation',
+                status: apt.consultationStatus || apt.status,
+                consultationId: apt.consultationId
+              }
+            }));
+            successCallback(events);
+          } catch (e) {
+            failureCallback(e);
+          }
+        },
+        eventClick: function (info) {
+          const p = info.event.extendedProps;
+          if (!p) return;
+          const time = info.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
+          const date = info.event.start.toLocaleDateString();
+
+          window.currentAptConsultId = p.consultationId;
+
+          const content = `
+                <div style="margin-bottom:12px">
+                    <div style="font-size:12px;color:var(--g500);font-weight:600;text-transform:uppercase;margin-bottom:4px">Your Name</div>
+                    <div style="font-size:16px;font-weight:700;color:white">${p.patientName}</div>
+                </div>
+                <div style="margin-bottom:12px">
+                    <div style="font-size:12px;color:var(--g500);font-weight:600;text-transform:uppercase;margin-bottom:4px">Service</div>
+                    <div style="font-size:15px;color:rgba(255,255,255,0.9)">${p.serviceName}</div>
+                </div>
+                <div style="display:flex;gap:20px;margin-bottom:12px">
+                    <div>
+                        <div style="font-size:12px;color:var(--g500);font-weight:600;text-transform:uppercase;margin-bottom:4px">Time</div>
+                        <div style="font-size:14px;color:rgba(255,255,255,0.9)">${date} ΓÇó ${time}</div>
+                    </div>
+                    <div>
+                        <div style="font-size:12px;color:var(--g500);font-weight:600;text-transform:uppercase;margin-bottom:4px">Status</div>
+                        <div style="font-size:14px;text-transform:capitalize;font-weight:600;color:${p.status === 'reviewed' ? '#00D9A3' : (p.status === 'completed' ? 'var(--blue)' : 'var(--amber)')}">${p.status}</div>
+                    </div>
+                </div>
+             `;
+          document.getElementById('apptDetailsContent').innerHTML = content;
+          document.getElementById('apptModal').classList.add('active');
+        }
+      });
+      patientCalendar.render();
+    }
+
     async function fetchConsultations() {
       if (!token) return;
       try {
@@ -5128,6 +5683,7 @@
           const data = await res.json();
           const list = document.getElementById('cList');
           if (data.consultations && data.consultations.length > 0) {
+            window.patientConsultations = data.consultations;
             list.innerHTML = data.consultations.map(c =>
               `<div style="padding:16px;border-bottom:1px solid var(--g100);display:flex;justify-content:space-between;align-items:center">
                   <div>
@@ -5200,6 +5756,16 @@
 
         const payData = await payRes.json();
 
+        // --- STAGING BYPASS FOR TESTING: DO NOT PUSH TO PRODUCTION ---
+        // Automatically skips Stripe and goes to scheduling if on staging (-fresh)
+        if (window.location.host.includes('-fresh')) {
+          console.warn("STAGING TEST BYPASS: Skipping Stripe Payment");
+          handlePaymentSuccess(consultationId);
+          closeConsult();
+          return;
+        }
+        // --- END STAGING BYPASS ---
+
         // 3. Redirect to Stripe
         window.location.href = payData.url;
 
@@ -5237,25 +5803,40 @@
             headers: { Authorization: `Bearer ${token}` }
           });
           const data = await res.json();
-          // Map Firestore appointments to FC events
-          const events = data.map(apt => ({
-            id: apt.id,
-            title: apt.patientName || 'Patient Visit',
-            start: apt.startTime, // ISO string
-            end: new Date(new Date(apt.startTime).getTime() + (apt.durationMinutes * 60000)).toISOString(),
-            backgroundColor: 'var(--blue)',
-            borderColor: 'var(--blue)',
-            extendedProps: {
-              patientName: apt.patientName || 'Unknown',
-              patientEmail: apt.patientEmail || '',
-              serviceName: apt.serviceName || 'Consultation',
-              status: apt.consultationStatus || apt.status,
-              consultationId: apt.consultationId
-            }
-          }));
+          const events = data.map(apt => {
+            if (apt.isBlock) return {
+              id: apt.id,
+              start: apt.start,
+              end: apt.end,
+              display: 'background',
+              backgroundColor: '#cbd5e1',
+              title: 'UNAVAILABLE'
+            };
+
+            return {
+              id: apt.id,
+              title: apt.patientName || 'Patient Visit',
+              start: apt.startTime,
+              end: new Date(new Date(apt.startTime).getTime() + (apt.durationMinutes * 60000)).toISOString(),
+              backgroundColor: 'var(--blue)',
+              borderColor: 'var(--blue)',
+              extendedProps: {
+                patientName: apt.patientName || 'Unknown',
+                patientEmail: apt.patientEmail || '',
+                serviceName: apt.serviceName || 'Consultation',
+                status: apt.consultationStatus || apt.status,
+                consultationId: apt.consultationId
+              }
+            };
+          });
           successCallback(events);
         },
         eventClick: function (info) {
+          if (info.event.display === 'background') {
+            // If background, allow unblocking on click? No, FC doesn't trigger eventClick for background events easily.
+            // We'll use dateClick for everything empty.
+            return;
+          }
           const p = info.event.extendedProps;
           if (!p) return;
           const time = info.event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
@@ -5283,14 +5864,24 @@
                         <div style="font-size:14px;text-transform:capitalize;font-weight:600;color:${p.status === 'reviewed' ? 'green' : (p.status === 'completed' ? 'blue' : 'orange')}">${p.status}</div>
                     </div>
                 </div>
-             `;
+              `;
           document.getElementById('apptDetailsContent').innerHTML = content;
           document.getElementById('apptModal').classList.add('active');
         },
-        dateClick: function (info) {
-          // Provider blocking logic here (Phase 7b)
-          if (confirm('Block this time slot?')) {
-            // createBlock(info.dateStr); 
+        dateClick: async function (info) {
+          if (confirm('Toggle availability for this slot?')) {
+            try {
+              const token = await auth.currentUser.getIdToken();
+              await fetch(`${API}/api/v1/doctor/availability/toggle`, {
+                method: 'POST',
+                headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
+                body: JSON.stringify({ startTime: info.dateStr })
+              });
+              calendar.refetchEvents();
+              toast('Availability updated');
+            } catch (e) {
+              toast('Error toggling availability');
+            }
           }
         }
       });
@@ -5307,8 +5898,11 @@
     }
 
     // --- PATIENT BOOKING WIZARD ---
-    function openBookingModal(consultId) {
-      // Robust Fallback Logic for Consultation ID
+    let selectedDoctorId = null;
+    let selectedDoctorName = null;
+    let doctorsData = [];
+
+    async function openBookingModal(consultId) {
       if (!consultId) consultId = currentConsultId;
       if (!consultId) {
         const params = new URLSearchParams(window.location.search);
@@ -5318,30 +5912,96 @@
 
       if (!consultId) {
         console.error('No consultation ID available for booking.');
-        return toast('Error: Unable to find consultation details. Please start over or contact support.');
+        return toast('Error: Unable to find consultation details.');
       }
 
       document.getElementById('bookingModal').classList.add('active');
       document.getElementById('bookingConsultId').value = consultId;
+
+      // Reset state
+      selectedDoctorId = null;
+      selectedDate = null;
+      selectedTime = null;
+      document.getElementById('step-doctor').classList.remove('hidden');
+      document.getElementById('bookingDetails').classList.add('hidden');
+      document.getElementById('btnBackToDoctors').classList.add('hidden');
+      document.getElementById('btnConfirmBook').disabled = true;
+
+      loadDoctors();
+    }
+
+    async function loadDoctors() {
+      const grid = document.getElementById('doctorGrid');
+      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--g500)">Loading doctors...</div>';
+
+      try {
+        const res = await fetch(`${API}/api/v1/doctors`);
+        doctorsData = await res.json();
+
+        if (doctorsData.length === 0) {
+          grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--g500)">No providers available at the moment.</div>';
+          return;
+        }
+
+        grid.innerHTML = doctorsData.map(doc => `
+            <div class="doctor-card" onclick="selectDoctor('${doc.id}')" style="background:rgba(255,255,255,0.03); border:1px solid var(--g200); border-radius:12px; padding:16px; cursor:pointer; transition:all 0.2s">
+                <div style="display:flex; align-items:center; gap:16px">
+                    <img src="${doc.photoUrl}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid var(--blue)">
+                    <div>
+                        <div style="font-weight:700; color:white; font-size:16px">${doc.name}</div>
+                        <div style="font-size:13px; color:var(--g500)">${doc.specialty}</div>
+                    </div>
+                </div>
+            </div>
+        `).join('');
+      } catch (e) {
+        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--red)">Failed to load providers.</div>';
+      }
+    }
+
+    function selectDoctor(id) {
+      selectedDoctorId = id;
+      const doc = doctorsData.find(d => d.id === id);
+      selectedDoctorName = doc.name;
+
+      document.getElementById('step-doctor').classList.add('hidden');
+      document.getElementById('bookingDetails').classList.remove('hidden');
+      document.getElementById('btnBackToDoctors').classList.remove('hidden');
+
+      document.getElementById('selectedDoctorInfo').innerHTML = `
+        <img src="${doc.photoUrl}" style="width:50px; height:50px; border-radius:50%; object-fit:cover">
+        <div>
+            <div style="font-weight:700; color:white">${doc.name}</div>
+            <div style="font-size:12px; color:var(--g500)">${doc.specialty}</div>
+        </div>
+      `;
+
       renderBookingDates();
     }
 
+    function backToDoctorSelection() {
+      document.getElementById('step-doctor').classList.remove('hidden');
+      document.getElementById('bookingDetails').classList.add('hidden');
+      document.getElementById('btnBackToDoctors').classList.add('hidden');
+      selectedDoctorId = null;
+    }
+
     function renderBookingDates() {
       const grid = document.getElementById('bookingDateGrid');
       grid.innerHTML = '';
       const today = new Date();
 
-      // Show next 14 days
-      for (let i = 1; i <= 14; i++) { // Start tomorrow
+      for (let i = 1; i <= 14; i++) {
         const d = new Date(today);
         d.setDate(today.getDate() + i);
         const isWeekend = d.getDay() === 0 || d.getDay() === 6;
 
         const div = document.createElement('div');
         div.className = `date-cell ${isWeekend ? 'disabled' : ''}`;
+        div.style.cssText = `background:rgba(255,255,255,0.03); border:1px solid var(--g200); border-radius:8px; padding:12px; text-align:center; cursor:${isWeekend ? 'not-allowed' : 'pointer'}`;
         div.innerHTML = `
-                <div style="font-size:11px;text-transform:uppercase;color:var(--g500)">${d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
-                <div style="font-size:16px;font-weight:700;color:var(--navy)">${d.getDate()}</div>
+                <div style="font-size:10px;text-transform:uppercase;color:var(--g500);margin-bottom:4px">${d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
+                <div style="font-size:16px;font-weight:700;color:white">${d.getDate()}</div>
             `;
         if (!isWeekend) {
           div.onclick = () => selectBookingDate(div, d);
@@ -5350,59 +6010,103 @@
       }
     }
 
-    function selectBookingDate(el, dateObj) {
-      document.querySelectorAll('.date-cell').forEach(c => c.classList.remove('selected'));
+    async function selectBookingDate(el, dateObj) {
+      document.querySelectorAll('.date-cell').forEach(c => {
+        c.classList.remove('selected');
+        c.style.borderColor = 'var(--g200)';
+        c.style.background = 'rgba(255,255,255,0.03)';
+      });
       el.classList.add('selected');
+      el.style.borderColor = 'var(--blue)';
+      el.style.background = 'rgba(91, 127, 255, 0.1)';
+
       selectedDate = dateObj;
-      renderBookingTimes(dateObj);
+      await fetchDoctorAvailability(dateObj);
     }
 
-    function renderBookingTimes(date) {
+    async function fetchDoctorAvailability(date) {
       const grid = document.getElementById('bookingTimeGrid');
-      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--g500)">Loading slots...</div>';
+      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--g500);padding:20px">Checking availability...</div>';
 
-      // Mock slots - in production fetch from API /api/v1/availability?date=...
-      const slots = ['09:00', '09:30', '10:00', '11:00', '13:00', '14:30', '15:00', '16:00'];
+      try {
+        // Fetch blocks for this doctor
+        const res = await fetch(`${API}/api/v1/doctor/availability?doctorId=${selectedDoctorId}`);
+        const blocks = await res.json();
 
-      grid.innerHTML = slots.map(t => `
-            <div class="time-slot" onclick="selectBookingTime(this, '${t}')">${formatTime(t)}</div>
+        // Fetch existing appointments (to avoid double booking)
+        const token = await auth.currentUser.getIdToken();
+        const aptRes = await fetch(`${API}/api/v1/doctor/appointments`, {
+          headers: { Authorization: `Bearer ${token}` }
+        });
+        const allApts = await aptRes.json();
+        const doctorApts = allApts.filter(a => a.providerId === selectedDoctorId && !a.isBlock);
+
+        // Generate standard slots: 9 AM to 5 PM
+        const slots = [];
+        const dayStr = date.toISOString().split('T')[0];
+
+        for (let h = 9; h < 17; h++) {
+          for (let m of ['00', '30']) {
+            const timeStr = `${h.toString().padStart(2, '0')}:${m}`;
+            const slotStart = new Date(`${dayStr}T${timeStr}:00`);
+
+            // Check if blocked
+            const isBlocked = blocks.find(b => new Date(b.startTime).getTime() === slotStart.getTime());
+            // Check if booked
+            const isBooked = doctorApts.find(a => new Date(a.startTime).getTime() === slotStart.getTime());
+
+            if (!isBlocked && !isBooked) {
+              slots.push(timeStr);
+            }
+          }
+        }
+
+        if (slots.length === 0) {
+          grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--red);padding:20px;font-size:13px">No slots available for this date.</div>';
+          return;
+        }
+
+        grid.innerHTML = slots.map(t => `
+            <div class="time-slot" onclick="selectBookingTime(this, '${t}')" style="background:rgba(255,255,255,0.03); border:1px solid var(--g200); border-radius:8px; padding:10px; text-align:center; cursor:pointer; color:white; font-size:14px">${formatTime(t)}</div>
         `).join('');
+      } catch (e) {
+        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--red);padding:20px">Error loading slots.</div>';
+      }
     }
 
     function selectBookingTime(el, timeStr) {
-      document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
-      el.classList.add('selected');
+      document.querySelectorAll('.time-slot').forEach(t => {
+        t.style.borderColor = 'var(--g200)';
+        t.style.background = 'rgba(255,255,255,0.03)';
+      });
+      el.style.borderColor = 'var(--blue)';
+      el.style.background = 'rgba(91, 127, 255, 0.1)';
+
       selectedTime = timeStr;
       document.getElementById('btnConfirmBook').disabled = false;
     }
 
-    function formatTime(timeStr) { // "09:00" -> "9:00 AM"
+    function formatTime(timeStr) {
       const [h, m] = timeStr.split(':');
-      return new Date(2000, 0, 1, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
+      const hr = parseInt(h);
+      const ampm = hr >= 12 ? 'PM' : 'AM';
+      const h12 = hr % 12 || 12;
+      return `${h12}:${m} ${ampm}`;
     }
 
     async function confirmBooking() {
-      if (!selectedDate || !selectedTime) {
-        console.error('Booking validation failed:', { selectedDate, selectedTime });
-        return toast('Please select both a date and time');
-      }
+      if (!selectedDate || !selectedTime || !selectedDoctorId) return toast('Please complete all selection steps.');
 
       const btn = document.getElementById('btnConfirmBook');
+      const originalText = btn.innerText;
       btn.disabled = true; btn.innerText = 'Booking...';
 
       try {
-        // Combine date & time
         const [h, m] = selectedTime.split(':');
         const startTime = new Date(selectedDate);
         startTime.setHours(parseInt(h), parseInt(m), 0, 0);
 
         const consultId = document.getElementById('bookingConsultId').value;
-        console.log('Booking attempt:', { consultId, startTime: startTime.toISOString(), selectedDate, selectedTime });
-
-        if (!consultId) {
-          throw new Error('No consultation ID found. Please try submitting your visit again.');
-        }
-
         const token = await auth.currentUser.getIdToken();
 
         const res = await fetch(`${API}/api/v1/appointments/book`, {
@@ -5410,24 +6114,23 @@
           headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
           body: JSON.stringify({
             consultationId: consultId,
-            startTime: startTime.toISOString()
+            startTime: startTime.toISOString(),
+            doctorId: selectedDoctorId,
+            localDate: selectedDate.getFullYear() + '-' + String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' + String(selectedDate.getDate()).padStart(2, '0'),
+            localTime: selectedTime
           })
         });
 
-        if (!res.ok) {
-          const errorText = await res.text();
-          console.error('Booking failed:', res.status, errorText);
-          throw new Error(errorText || 'Slot taken');
-        }
+        if (!res.ok) throw new Error(await res.text());
 
-        // Success
         document.getElementById('bookingModal').classList.remove('active');
         showBookingSuccess(startTime);
+        toast(`Successfully booked with ${selectedDoctorName}!`);
 
       } catch (e) {
         console.error('Booking error:', e);
         toast('Booking Failed: ' + e.message);
-        btn.disabled = false; btn.innerText = 'Confirm Appointment';
+        btn.disabled = false; btn.innerText = originalText;
       }
     }
 
@@ -5457,14 +6160,21 @@
     function switchAdminTab(tab) {
       document.getElementById('view-admin-consults').style.display = 'none';
       document.getElementById('view-admin-messages').style.display = 'none';
+      const userView = document.getElementById('view-admin-users');
+      if (userView) userView.style.display = 'none';
       const scheduleView = document.getElementById('view-admin-schedule');
       if (scheduleView) scheduleView.style.display = 'none';
+      const pacsView = document.getElementById('view-admin-pacs');
+      if (pacsView) pacsView.style.display = 'none';
 
       if (tab === 'consults') {
         document.getElementById('view-admin-consults').style.display = 'block';
       } else if (tab === 'messages') {
         document.getElementById('view-admin-messages').style.display = 'flex';
         loadAdminThreads();
+      } else if (tab === 'users') {
+        if (userView) userView.style.display = 'block';
+        loadAdminUsers();
       } else if (tab === 'schedule') {
         if (!scheduleView) return;
         scheduleView.style.display = 'block';
@@ -5473,13 +6183,82 @@
 
       document.getElementById('tab-admin-consults').classList.toggle('active', tab === 'consults');
       document.getElementById('tab-admin-messages').classList.toggle('active', tab === 'messages');
+      const tabUsers = document.getElementById('tab-admin-users');
+      if (tabUsers) tabUsers.classList.toggle('active', tab === 'users');
       const tabSched = document.getElementById('tab-admin-schedule');
       if (tabSched) tabSched.classList.toggle('active', tab === 'schedule');
     }
 
+    window.openPACS = function (url) {
+      console.log('Opening PACS with URL:', url);
+      // Hide all other views
+      const views = ['view-admin-consults', 'view-admin-messages', 'view-admin-users', 'view-admin-schedule'];
+      views.forEach(v => {
+        const el = document.getElementById(v);
+        if (el) el.style.display = 'none';
+      });
+
+      // Show PACS view
+      const pacsView = document.getElementById('view-admin-pacs');
+      if (pacsView) {
+        console.log('Showing view-admin-pacs');
+        pacsView.style.display = 'block';
+        const frame = document.getElementById('pacsFrame');
+        if (frame) {
+          console.log('Setting pacsFrame.src');
+          frame.src = url;
+          // Security check: If we can detect it failed to load (hard in many cases), we could alert.
+        } else {
+          console.error('pacsFrame not found');
+        }
+      } else {
+        console.error('view-admin-pacs not found');
+      }
+
+      // Deactivate all tabs
+      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
+    }
+
     function showAdminSchedule() {
       // Helper specifically for schedule tab
       switchAdminTab('schedule');
+      // Set default dates
+      const today = new Date().toISOString().split('T')[0];
+      const startInput = document.getElementById('availStartDate');
+      const endInput = document.getElementById('availEndDate');
+      if (startInput && !startInput.value) startInput.value = today;
+      if (endInput && !endInput.value) endInput.value = today;
+    }
+
+    async function addAvailabilityRange() {
+      const startDate = document.getElementById('availStartDate').value;
+      const startTime = document.getElementById('availStartTime').value;
+      const endDate = document.getElementById('availEndDate').value;
+      const endTime = document.getElementById('availEndTime').value;
+
+      if (!startDate || !startTime || !endDate || !endTime) {
+        return toast('Please select all dates and times');
+      }
+
+      const startDateTime = `${startDate}T${startTime}:00`;
+      const endDateTime = `${endDate}T${endTime}:00`;
+
+      try {
+        const token = await auth.currentUser.getIdToken();
+        const res = await fetch(`${API}/api/v1/doctor/availability/add-range`, {
+          method: 'POST',
+          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
+          body: JSON.stringify({ startDateTime, endDateTime })
+        });
+
+        if (!res.ok) throw new Error(await res.text());
+
+        toast('Availability range added');
+        if (calendar) calendar.refetchEvents();
+      } catch (e) {
+        console.error(e);
+        toast('Error adding availability: ' + e.message);
+      }
     }
 
     async function loadAdminThreads() {
@@ -5516,6 +6295,210 @@
       }
     }
 
+    /* === USER MANAGEMENT LOGIC === */
+    function toggleAddUserForm() {
+      const f = document.getElementById('addUserForm');
+      f.style.display = f.style.display === 'none' ? 'flex' : 'none';
+    }
+
+    async function createNewUser() {
+      const firstName = document.getElementById('newUserFirstName').value;
+      const lastName = document.getElementById('newUserLastName').value;
+      const email = document.getElementById('newUserEmail').value;
+      const password = document.getElementById('newUserPassword').value;
+      const role = document.getElementById('newUserRole').value;
+
+      if (!firstName || !lastName || !email || !password) return toast('Please fill all fields');
+      if (password.length < 6) return toast('Password must be at least 6 characters');
+
+      try {
+        toast('Creating user...');
+        const token = await auth.currentUser.getIdToken();
+        const res = await fetch(`${API}/api/v1/admin/users/create`, {
+          method: 'POST',
+          headers: {
+            'Content-Type': 'application/json',
+            'Authorization': `Bearer ${token}`
+          },
+          body: JSON.stringify({ firstName, lastName, email, password, role })
+        });
+
+        if (!res.ok) throw new Error(await res.text());
+
+        toast('User created successfully!');
+        toggleAddUserForm();
+        loadAdminUsers();
+
+        // Clear inputs
+        document.getElementById('newUserFirstName').value = '';
+        document.getElementById('newUserLastName').value = '';
+        document.getElementById('newUserEmail').value = '';
+        document.getElementById('newUserPassword').value = '';
+
+      } catch (e) {
+        console.error(e);
+        toast('Error creating user: ' + e.message);
+      }
+    }
+
+    async function loadDashUsers() {
+      const tbody = document.getElementById('dashUserTableBody');
+      if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;text-align:center">Loading Users...</td></tr>';
+
+      try {
+        const token = await auth.currentUser.getIdToken();
+        const res = await fetch(`${API}/api/v1/admin/users`, {
+          headers: { 'Authorization': `Bearer ${token}` }
+        });
+        const data = await res.json();
+
+        if (!data.success) throw new Error(data.error);
+        if (!data.users || data.users.length === 0) {
+          if (tbody) tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;text-align:center">No users found.</td></tr>';
+          return;
+        }
+
+        if (tbody) {
+          tbody.innerHTML = data.users.map(u => {
+            const roleColor = u.role === 'admin' ? 'var(--red)' : (u.role === 'provider' || u.role === 'doctor' ? 'var(--blue)' : 'var(--g500)');
+            const statusStr = u.disabled ? '<span style="color:var(--red)">Suspended</span>' : '<span style="color:var(--emerald)">Active</span>';
+
+            return `
+              <tr style="border-bottom:1px solid var(--g100)">
+                  <td style="padding:15px">
+                    <div style="font-weight:700;color:var(--navy);font-size:14px">${u.displayName}</div>
+                    <div style="font-size:12px;color:var(--g500);margin-top:2px">${u.email}</div>
+                  </td>
+                  <td style="padding:15px">
+                      <span style="font-size:11px;font-weight:800;text-transform:uppercase;padding:4px 8px;border-radius:4px;background:var(--g50);color:${roleColor}">
+                          ${u.role}
+                      </span>
+                  </td>
+                  <td style="padding:15px;font-weight:600;font-size:12px">${statusStr}</td>
+                  <td style="padding:15px">
+                      <div style="display:flex;gap:8px;align-items:center">
+                        <select onchange="updateDashUser('${u.uid}', 'role', this.value)" style="padding:6px;border-radius:4px;border:1px solid var(--g200);font-size:12px;max-width:120px">
+                            <option value="patient" ${u.role === 'patient' ? 'selected' : ''}>Patient</option>
+                            <option value="provider" ${u.role === 'provider' || u.role === 'doctor' ? 'selected' : ''}>Provider</option>
+                            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
+                        </select>
+                        <button class="btn btn-outline" style="padding:4px 8px;font-size:11px" onclick="updateDashUser('${u.uid}', 'disabled', ${!u.disabled})">
+                          ${u.disabled ? 'Enable' : 'Disable'}
+                        </button>
+                        <button class="btn btn-primary" style="padding:4px 8px;font-size:11px;background:var(--red);border-color:var(--red)" onclick="deleteDashUser('${u.uid}')">≡ƒùæ∩╕Å</button>
+                      </div>
+                  </td>
+              </tr>
+            `;
+          }).join('');
+        }
+      } catch (e) {
+        console.error(e);
+        if (tbody) tbody.innerHTML = `<tr><td colspan="4" style="padding:20px;text-align:center;color:red">Permission Denied or Error loading users.</td></tr>`;
+      }
+    }
+
+    async function updateDashUser(uid, field, value) {
+      if (field === 'role' && !confirm('Are you sure you want to change this user\'s access privileges?')) return;
+      if (field === 'disabled' && !confirm('Are you sure you want to ' + (value ? 'disable' : 'enable') + ' this account?')) return;
+
+      try {
+        toast(`Updating user...`);
+        const token = await auth.currentUser.getIdToken();
+        const bodyPayload = {};
+        bodyPayload[field] = value;
+
+        const res = await fetch(`${API}/api/v1/admin/users/${uid}`, {
+          method: 'PATCH',
+          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
+          body: JSON.stringify(bodyPayload)
+        });
+        const data = await res.json();
+        if (!data.success) throw new Error(data.error);
+
+        toast('User updated successfully!');
+        loadDashUsers();
+      } catch (e) {
+        console.error('Update failed:', e);
+        toast('Error: ' + e.message);
+      }
+    }
+
+    async function deleteDashUser(uid) {
+      if (!confirm('WARNING: PERMANENTLY DELETE user? This action cannot be undone!')) return;
+      try {
+        toast(`Deleting user...`);
+        const token = await auth.currentUser.getIdToken();
+        const res = await fetch(`${API}/api/v1/admin/users/${uid}`, {
+          method: 'DELETE',
+          headers: { 'Authorization': `Bearer ${token}` }
+        });
+        const data = await res.json();
+        if (!data.success) throw new Error(data.error);
+
+        toast('User deleted forever.');
+        loadDashUsers();
+      } catch (e) {
+        console.error('Delete failed:', e);
+        toast('Error: ' + e.message);
+      }
+    }
+
+    async function createDashUser() {
+      const firstName = document.getElementById('dashNewUserFirstName').value;
+      const lastName = document.getElementById('dashNewUserLastName').value;
+      const email = document.getElementById('dashNewUserEmail').value;
+      const password = document.getElementById('dashNewUserPassword').value;
+      const role = document.getElementById('dashNewUserRole').value;
+
+      if (!firstName || !email || !password) return toast('Please fill all required fields');
+      if (password.length < 6) return toast('Password must be at least 6 characters');
+
+      try {
+        toast('Creating user account...');
+        const token = await auth.currentUser.getIdToken();
+        const displayName = firstName + (lastName ? ' ' + lastName : '');
+
+        const res = await fetch(`${API}/api/v1/admin/users`, {
+          method: 'POST',
+          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
+          body: JSON.stringify({ displayName, email, password, role })
+        });
+        const data = await res.json();
+        if (!data.success) throw new Error(data.error);
+
+        toast('Account provisioned successfully!');
+        document.getElementById('dashAddUserForm').classList.add('hidden');
+        loadDashUsers();
+
+        // Clear inputs
+        ['FirstName', 'LastName', 'Email', 'Password'].forEach(id => document.getElementById('dashNewUser' + id).value = '');
+      } catch (e) {
+        console.error(e);
+        toast('Error creating user: ' + e.message);
+      }
+    }
+
+    // Keep the old deprecated legacy functions just in case they're used elsewhere. Wait, I should override loadAdminUsers since I used it inside the EMR admin portal tab.
+    async function loadAdminUsers() {
+      loadDashUsers();
+    }
+
+
+    async function updateUserRole(uid, newRole) {
+      try {
+        toast(`Updating ${uid} to ${newRole}...`);
+        await db.collection('patients').doc(uid).update({
+          role: newRole
+        });
+        toast('Role updated successfully!');
+        loadAdminUsers(); // Refresh
+      } catch (e) {
+        console.error('Update Role failed:', e);
+        toast('Error: Permission Denied');
+      }
+    }
+
     function renderThreadList(threads) {
       const list = document.getElementById('msgThreadList');
       list.innerHTML = threads.map(t => {
@@ -5680,7 +6663,7 @@
             <td style="padding:12px"><span style="color:${statusColor};font-weight:600;text-transform:capitalize">${c.status}</span></td>
             <td style="padding:12px;display:flex;gap:8px">
               <button class="btn btn-outline" style="padding:6px 12px;font-size:12px" onclick="viewIntake('${c.id}')">View Intake</button>
-              <a href="${viewerLink}" target="_blank" class="btn btn-primary" style="padding:6px 12px;font-size:12px;text-decoration:none">View PACS</a>
+              <a href="javascript:void(0)" onclick="openPACS('https://patriotictelehealth.cloudflareaccess.com/cdn-cgi/access/login/pacs.patriotictelehealth.com?kid=50d12b77a557150adfb69118eca44c243524d89794459b29611a7326d9485b5c&amp;meta=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6ImQwNDZhODYwMmEyNzlmZTg2ZDZhNWE2MzlkMmYwMjE0YmRmNDlhMmM0YTFjM2I5YTdiNmRmNDZjYjJkMmQ0MGMifQ.eyJ0eXBlIjoibWV0YSIsImF1ZCI6IjUwZDEyYjc3YTU1NzE1MGFkZmI2OTExOGVjYTQ0YzI0MzUyNGQ4OTc5NDQ1OWIyOTYxMWE3MzI2ZDk0ODViNWMiLCJob3N0bmFtZSI6InBhY3MucGF0cmlvdGljdGVsZWhlYWx0aC5jb20iLCJyZWRpcmVjdF91cmwiOiIvIiwic2VydmljZV90b2tlbl9zdGF0dXMiOmZhbHNlLCJpc193YXJwIjpmYWxzZSwiaXNfZ2F0ZXdheSI6ZmFsc2UsImV4cCI6MTc3MTY0Mzc1NywibmJmIjoxNzcxNjQzNDU3LCJpYXQiOjE3NzE2NDM0NTcsImF1dGhfc3RhdHVzIjoiTk9ORSIsIm10bHNfYXV0aCI6eyJjZXJ0X2lzc3Vlcl9kbiI6IiIsImNlcnRfc2VyaWFsIjoiIiwiY2VydF9pc3N1ZXJfc2tpIjoiIiwiY2VydF9wcmVzZW50ZWQiOmZhbHNlLCJjb21tb25fbmFtZSI6IiIsImF1dGhfc3RhdHVzIjoiTk9ORSJ9LCJyZWFsX2NvdW50cnkiOiJVUyIsImFwcF9zZXNzaW9uX2hhc2giOiJjOTZiNjhmOGEyZjYzNzhmYzhhYzA0OTM3YWJkMzkyMDIyN2U4ZWVmZDUzYmNkOGRkZTUxOGQwMTQ2MGZjMDZjIn0.Hz2Svg-SbF3Oi_P_CzJFodwLybyBgJ24PTka6dFjr1v5KjfbNsHVWsyjUvPTrZgJJ0de-0nktzr-rysESAc1EeqA_YotbvPuIkS-W40nJoLfbHwK22f_3RGfGUbnH8sgpIImbggoTBSyUqznLDVMF4uj9pe2KFDnobEtJoprONe1qGT_zwzB8fyVwGaWTNUe74U5EL4paLV88HbV6_0N_ekgFsXuYO5aL_dguN75xq2FeGu8zldtnpKI2FZ9h-3CZ0FSWSPYLPVu1DmhI-lhjQO-7TXmbK4isQNG-x837taraPnaEWZjhk_j7wbm1eI4rJV44H2vJjLZ4dbkFqHl5g&amp;redirect_url=%2F')" class="btn btn-primary" style="padding:6px 12px;font-size:12px;text-decoration:none">View PACS</a>
               <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px" onclick="markReviewed('${c.id}')">Start Review</button>
             </td>
           </tr>
@@ -5704,14 +6687,14 @@
     }
 
     function viewIntake(id) {
-      if (!adminConsults) return;
-      const consult = adminConsults.find(c => c.id === id);
+      const allConsults = [...(window.adminConsults || []), ...(window.patientConsultations || [])];
+      const consult = allConsults.find(c => c.id === id);
       if (!consult || !consult.intake) return toast('No intake data available');
 
       const intakeHtml = Object.entries(consult.intake).map(([k, v]) => {
         const label = k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
         const val = typeof v === 'boolean' ? (v ? 'Yes' : 'No') : v;
-        return `<div style="margin-bottom:8px"><div style="font-size:12px;color:var(--g500)">${label}</div><div style="font-weight:500">${val}</div></div>`;
+        return `<div style="margin-bottom:8px"><div style="font-size:12px;color:var(--g500)">${label}</div><div style="font-weight:500;color:white">${val}</div></div>`;
       }).join('');
 
       document.getElementById('intakeContent').innerHTML = intakeHtml || '<p>No intake data provided.</p>';
@@ -5764,13 +6747,13 @@
       const email = p.email || 'N/A';
 
       container.innerHTML = `
-            <div style="display:grid;grid-template-columns:1fr 1fr;height:100%;overflow:hidden">
+            <div style="display:grid;grid-template-columns:1fr 1fr;height:100%;overflow:hidden;background:#000000">
                 <!-- LEFT SIDEBAR: DEMOGRAPHICS -->
-                <div style="border-right:1px solid var(--g200);background:var(--g50);padding:40px;display:flex;flex-direction:column;gap:32px;overflow-y:auto">
+                <div style="border-right:1px solid rgba(255,255,255,0.1);background:#0A0F1C;padding:40px;display:flex;flex-direction:column;gap:32px;overflow-y:auto">
                     
                     <!-- Profile Header -->
                     <div style="text-align:center">
-                        <div style="width:100px;height:100px;background:#0A0F1C;border:2px solid rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:42px;margin:0 auto 20px;color:var(--blue);font-weight:700;box-shadow:var(--sh-md)">
+                        <div style="width:100px;height:100px;background:#1F2937;border:2px solid rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:42px;margin:0 auto 20px;color:var(--blue);font-weight:700;box-shadow:var(--sh-md)">
                             ${name.charAt(0)}
                         </div>
                         <h2 style="margin:0;font-size:26px;color:#FFFFFF;font-weight:800;letter-spacing:-0.5px">${name}</h2>
@@ -5782,7 +6765,7 @@
                     </div>
 
                     <!-- Details Card -->
-                    <div style="background:#0A0F1C;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;box-shadow:var(--sh-sm)">
+                    <div style="background:#1F2937;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;box-shadow:var(--sh-sm)">
                         <h4 style="margin:0 0 20px 0;font-size:14px;text-transform:uppercase;color:rgba(255,255,255,0.5);letter-spacing:1px;font-weight:700">Patient Details</h4>
                         <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px 16px">
                             
@@ -5816,10 +6799,10 @@
                 </div>
 
                 <!-- RIGHT CONTENT -->
-                <div style="flex:1;overflow-y:auto;padding-right:10px">
+                <div style="flex:1;overflow-y:auto;padding:20px;background:#000000">
                     
                     <!-- TABS -->
-                    <div class="chart-tabs">
+                    <div class="chart-tabs" style="margin:-20px -20px 20px -20px">
                         <div class="chart-tab active" onclick="switchTab('tab-notes', this)">Clinical Notes</div>
                         <div class="chart-tab" onclick="switchTab('tab-labs', this)">Labs & Results</div>
                         <div class="chart-tab" onclick="switchTab('tab-vitals', this)">Vitals</div>
@@ -5827,7 +6810,7 @@
                     </div>
 
                     <!-- TAB: NOTES -->
-                    <div id="tab-notes" class="chart-content active">
+                    <div id="tab-notes" class="chart-content active" style="padding:0;background:transparent">
                         <button class="btn btn-primary" style="width:100%;margin-bottom:20px" onclick="toggleSoapForm()">+ Add SOAP Note</button>
                         
                         <!-- SOAP FORM (Hidden by default) -->
@@ -5856,7 +6839,7 @@
                              
                              <textarea id="soapP" placeholder="Plan" style="width:100%;padding:8px;margin-bottom:15px;background:#1F2937;color:white;border:1px solid rgba(255,255,255,0.1);border-radius:4px;min-height:60px"></textarea>
                              <div style="display:flex;gap:10px;justify-content:flex-end">
-                                 <button class="btn btn-ghost" onclick="toggleSoapForm()">Cancel</button>
+                                 <button class="btn btn-ghost" onclick="toggleSoapForm()" style="color:white">Cancel</button>
                                  <button class="btn btn-primary" onclick="saveSoapNote('${p.uid}')">Save Note</button>
                              </div>
                         </div>
@@ -5884,29 +6867,29 @@
                     </div>
 
                     <!-- TAB: LABS -->
-                    <div id="tab-labs" class="chart-content">
+                    <div id="tab-labs" class="chart-content" style="padding:0;background:transparent">
                         <button class="btn btn-primary" style="width:100%;margin-bottom:20px" onclick="toggleLabForm()">+ New Lab Order</button>
                         
                         <!-- LAB FORM -->
-                        <div id="labForm" style="display:none;background:var(--g50);padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid var(--g200)">
-                            <h4 style="margin-top:0;color:var(--navy)">Order Labs</h4>
+                        <div id="labForm" style="display:none;background:#111827;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1)">
+                            <h4 style="margin-top:0;color:#FFFFFF">Order Labs</h4>
                             <div style="margin-bottom:12px">
-                                <label style="display:block;font-size:12px;font-weight:700;margin-bottom:4px;color:var(--navy)">Select Panels</label>
+                                <label style="display:block;font-size:12px;font-weight:700;margin-bottom:4px;color:#FFFFFF">Select Panels</label>
                                 <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="CBC"> CBC</label>
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="CMP"> CMP</label>
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="Lipid Panel"> Lipid Panel</label>
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="Testosterone Free/Total"> Testosterone</label>
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="PSA"> PSA</label>
-                                    <label class="ro"><input type="checkbox" class="lab-panel" value="Estradiol"> Estradiol</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="CBC"> CBC</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="CMP"> CMP</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="Lipid Panel"> Lipid Panel</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="Testosterone Free/Total"> Testosterone</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="PSA"> PSA</label>
+                                    <label class="ro" style="color:white"><input type="checkbox" class="lab-panel" value="Estradiol"> Estradiol</label>
                                 </div>
                             </div>
                             <div style="margin-bottom:12px">
-                                <label style="display:block;font-size:12px;font-weight:700;margin-bottom:4px;color:var(--navy)">Diagnosis Code</label>
-                                <input id="labDiagnosis" type="text" placeholder="e.g. E29.1" style="width:100%;padding:8px;border:1px solid var(--g200);border-radius:4px">
+                                <label style="display:block;font-size:12px;font-weight:700;margin-bottom:4px;color:#FFFFFF">Diagnosis Code</label>
+                                <input id="labDiagnosis" type="text" placeholder="e.g. E29.1" style="width:100%;padding:8px;background:#1F2937;color:white;border:1px solid rgba(255,255,255,0.1);border-radius:4px">
                             </div>
                             <div style="display:flex;gap:10px;justify-content:flex-end">
-                                <button class="btn btn-ghost" onclick="toggleLabForm()">Cancel</button>
+                                <button class="btn btn-ghost" onclick="toggleLabForm()" style="color:white">Cancel</button>
                                 <button class="btn btn-primary" onclick="createLabOrder('${p.uid}')">Create Order & Req</button>
                             </div>
                         </div>
@@ -5917,25 +6900,25 @@
                         </div>
                     </div>
 
-                    <!-- TAB: HISTORY -->
-                    <div id="tab-vitals" class="chart-content">
-                        <div style="background:white;border:1px solid var(--g200);border-radius:12px;padding:20px;margin-bottom:20px">
-                            <h3 style="margin-top:0;color:var(--navy);font-size:16px">Weight (lbs)</h3>
-                            <div style="height:200px;display:flex;align-items:flex-end;gap:10px;padding-top:20px;border-bottom:1px solid var(--g200);position:relative">
+                    <!-- TAB: VITALS -->
+                    <div id="tab-vitals" class="chart-content" style="padding:0;background:transparent">
+                        <div style="background:#111827;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:20px">
+                            <h3 style="margin-top:0;color:#FFFFFF;font-size:16px">Weight (lbs)</h3>
+                            <div style="height:200px;display:flex;align-items:flex-end;gap:10px;padding-top:20px;border-bottom:1px solid rgba(255,255,255,0.1);position:relative">
                                 ${[185, 184, 182, 181, 180, 178].map((w, i) => `
-                                    <div style="flex:1;background:var(--blue-pale);border-radius:4px 4px 0 0;height:${(w - 150) * 3}px;position:relative;transition:all 0.2s" title="${w} lbs">
+                                    <div style="flex:1;background:rgba(59,130,246,0.3);border-radius:4px 4px 0 0;height:${(w - 150) * 3}px;position:relative;transition:all 0.2s" title="${w} lbs">
                                         <div style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:700;color:var(--blue)">${w}</div>
                                     </div>
                                 `).join('')}
-                                <div style="position:absolute;bottom:-25px;left:0;right:0;display:flex;justify-content:space-around;font-size:11px;color:var(--g500)">
+                                <div style="position:absolute;bottom:-25px;left:0;right:0;display:flex;justify-content:space-around;font-size:11px;color:rgba(255,255,255,0.5)">
                                     <span>Jan</span><span>Feb</span><span>Mar</span><span>Apr</span><span>May</span><span>Jun</span>
                                 </div>
                             </div>
                         </div>
 
-                        <div style="background:white;border:1px solid var(--g200);border-radius:12px;padding:20px">
-                             <h3 style="margin-top:0;color:var(--navy);font-size:16px">Blood Pressure</h3>
-                             <div style="height:150px;border-left:1px solid var(--g200);border-bottom:1px solid var(--g200);position:relative;margin-top:20px">
+                        <div style="background:#111827;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px">
+                             <h3 style="margin-top:0;color:#FFFFFF;font-size:16px">Blood Pressure</h3>
+                             <div style="height:150px;border-left:1px solid rgba(255,255,255,0.1);border-bottom:1px solid rgba(255,255,255,0.1);position:relative;margin-top:20px">
                                 <!-- Mock Line Chart -->
                                 <svg style="width:100%;height:100%;overflow:visible">
                                     <polyline points="0,80 50,75 100,78 150,72 200,70 250,68" fill="none" stroke="var(--blush)" stroke-width="2" />
@@ -5958,15 +6941,15 @@
                                  <div style="display:flex;gap:15px;margin-top:10px;font-size:11px">
                                     <span style="color:var(--blue)">ΓùÅ Systolic</span>
                                     <span style="color:var(--blush)">ΓùÅ Diastolic</span>
-                                </div>
+                                 </div>
                              </div>
                         </div>
                     </div>
 
                     <!-- TAB: HISTORY -->
-                    <div id="tab-history" class="chart-content">
+                    <div id="tab-history" class="chart-content" style="padding:0;background:transparent">
                         <div style="display:grid;gap:10px">
-                            ${history.map(h => {
+                            ${history.length === 0 ? '<div style="color:rgba(255,255,255,0.5);font-style:italic">No previous visits recorded.</div>' : history.map(h => {
         const d = h.createdAt ? new Date(h.createdAt._seconds * 1000).toLocaleDateString() : 'Unknown';
         const svc = (h.serviceKey || 'General').replace(/_/g, ' ');
         const stat = h.status.toUpperCase();
@@ -6265,24 +7248,65 @@
         document.getElementById('signupBtn').classList.add('hidden');
         document.getElementById('logoutBtn').classList.remove('hidden');
 
-        // Show Admin Button
-        const nav = document.querySelector('.nav-links');
-        if (!document.getElementById('adminLink')) {
-          const adminLink = document.createElement('a');
-          adminLink.id = 'adminLink';
-          adminLink.href = 'javascript:void(0)';
-          adminLink.textContent = 'Provider Portal';
-          adminLink.setAttribute('onclick', 'openProviderPortal()'); // Use Attribute for reliability
-          adminLink.style.fontWeight = 'bold';
-          adminLink.style.color = 'white';
-          nav.insertBefore(adminLink, nav.firstChild);
+        // --- ROLE-BASED PORTAL VISIBILITY ---
+        try {
+          const doc = await db.collection('patients').doc(u.uid).get();
+          const userData = doc.exists ? doc.data() : null;
+          const role = (userData && userData.role) ? userData.role.toLowerCase() : 'patient';
+          const isStaff = role === 'admin' || role === 'doctor' || role === 'provider';
+
+          console.log('[Auth] User:', u.uid, 'Role:', role, 'isStaff:', isStaff);
+
+          const nav = document.querySelector('.nav-links');
+          const actions = document.querySelector('.nav-actions');
+
+          if (isStaff) {
+            // 1. Provider Portal (Internal Admin)
+            if (!document.getElementById('adminLink')) {
+              const adminLink = document.createElement('a');
+              adminLink.id = 'adminLink';
+              adminLink.href = 'javascript:void(0)';
+              adminLink.textContent = 'Provider Portal';
+              adminLink.setAttribute('onclick', 'openProviderPortal()');
+              adminLink.style.fontWeight = 'bold';
+              adminLink.style.color = 'white';
+              nav.insertBefore(adminLink, nav.firstChild);
+            }
+
+            // 2. EMR Portal (External Next.js App)
+            if (!document.getElementById('emrLink')) {
+              const emrLink = document.createElement('a');
+              emrLink.id = 'emrLink';
+              // Check if on staging or prod for correct routing
+              const isStaging = window.location.host.includes('fresh');
+              emrLink.href = isStaging ? 'https://patriotic-virtual-emr--emr-fresh-lq8cdyzq.web.app/login' : 'https://patriotic-virtual-emr.web.app/login';
+              emrLink.target = '_blank';
+              emrLink.textContent = 'EMR Portal Γåù';
+              emrLink.className = 'btn btn-ghost'; // Ghost button style
+              emrLink.style.fontWeight = 'bold';
+              emrLink.style.color = 'var(--blue-light)';
+              actions.insertBefore(emrLink, document.getElementById('loginBtn'));
+            }
+          } else {
+            // REMOVE PORTS if patient
+            const al = document.getElementById('adminLink');
+            if (al) al.remove();
+            const el = document.getElementById('emrLink');
+            if (el) el.remove();
+          }
+        } catch (e) {
+          console.error('Role check failed:', e);
         }
       } else {
         document.getElementById('loginBtn').classList.remove('hidden');
         document.getElementById('signupBtn').classList.remove('hidden');
         document.getElementById('logoutBtn').classList.add('hidden');
+
         const al = document.getElementById('adminLink');
         if (al) al.remove();
+        const el = document.getElementById('emrLink');
+        if (el) el.remove();
+
         document.getElementById('adminDashboard').classList.add('hidden');
         showLanding();
       }
@@ -6502,6 +7526,7 @@
 
     // Ensure adminConsults is global
     window.adminConsults = [];
+    window.patientConsultations = [];
 
     renderSvc('popular'); updateNav();
 
